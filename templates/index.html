<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Planner</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            width: 20%; /* Set a fixed width for each column */
        }

        button {
            border: 1px solid black;
            padding: 10px 20px;
            margin-right: 5px;
            cursor: pointer;
            font-weight: bold; /* Make text bold */
        }

        .delete {
            background-color: #ff6347; /* Red */
            color: white;
        }

        .in-progress {
            background-color: #ffd700; /* Yellow */
            color: black;
        }

        .done {
            background-color: #00ff00; /* Green */
            color: white;
        }

        .to-do {
            background-color: grey;
            color: white;
        }

        .status-box {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid black;
            margin-right: 5px;
            position: relative;
        }

        .status-name {
            display: inline-block;
            text-align: center;
            font-weight: bold;
            width: 100%; /* Ensure the name occupies the entire width of the square */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .status-to-do {
            background-color: grey;
        }

        .status-in-progress {
            background-color: #ffd700;
        }

        .status-done {
            background-color: #00ff00;
        }

        /* Adjust width of the "With" column */
        .with-column {
            width: auto; /* Set width to auto to align with the longest text */
        }
    </style>
</head>
<body>
    <h1>Add Task</h1>
    <form id="taskForm">
        <label for="name">Task Name:</label><br>
        <input type="text" id="name" name="name" style="width: 3cm; height: 1cm;"><br> <!-- Set width and height -->
        <label for="description">Task Description:</label><br>
        <input type="text" id="description" name="description" style="width: 3cm; height: 1cm;"><br> <!-- Set width and height -->
        <label for="category_id">Category:</label><br>
        <select id="category_id" name="category_id" style="width: 3cm; height: 1cm;">
            <!-- Set width and height -->
            <option value="" disabled selected>Select category</option>
        </select><br>
        <label for="colleague_id">With:</label><br>
        <select id="colleague_id" name="colleague_id" style="width: 3cm; height: 1cm;">
            <!-- Set width and height -->
            <option value="" selected>Select colleague</option>
        </select>
        <button type="button" onclick="showColleagueForm()">Add New Colleague</button><br>
        <button type="button" onclick="submitForm()">Submit</button>
        <p id="responseMsg"></p>
    </form>

    <h1 id="allTasksHeading" style="display: none;">All Tasks</h1>
    <button onclick="showTasks()">Show Tasks</button>
    <div id="taskTables" style="display: none;"></div>

    <div id="colleagueForm" style="display: none;">
        <h2>Add New Colleague</h2>
        <form id="addColleagueForm">
            <label for="colleagueName">Colleague Name:</label><br>
            <input type="text" id="colleagueName" name="name"><br>
            <button type="button" onclick="addColleague()">Add Colleague</button>
            <p id="colleagueResponseMsg"></p>
        </form>
    </div>

    <script>
        // Function to submit form data
        function submitForm() {
            const form = document.getElementById('taskForm');
            const formData = new FormData(form);
            const categoryId = document.getElementById('category_id').value; // Get the selected category ID
            const colleagueId = document.getElementById('colleague_id').value; // Get the selected colleague ID
            formData.append('category_id', categoryId); // Append the category ID to form data
            formData.append('colleague_id', colleagueId); // Append the colleague ID to form data

            fetch('/add_task', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('responseMsg').textContent = data.message;
                    // Clear form fields after successful submission
                    form.reset();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Function to show tasks
        function showTasks() {
            fetch('/get_tasks').then(response => response.json())
                .then(tasks => {
                    const taskTables = document.getElementById('taskTables');
                    taskTables.innerHTML = ''; // Clear previous tables

                    // Group tasks by category
                    const groupedTasks = tasks.reduce((acc, task) => {
                        acc[task.category] = acc[task.category] || [];
                        acc[task.category].push(task);
                        return acc;
                    }, {});

                    // Sort categories alphabetically
                    const sortedCategories = Object.keys(groupedTasks).sort();

                    // Find the maximum width required for the "With" column
                    let maxWithColumnWidth = 0;
                    tasks.forEach(task => {
                        const withColumnWidth = task.with.length * 8; // Assuming each character requires 8px width
                        if (withColumnWidth > maxWithColumnWidth) {
                            maxWithColumnWidth = withColumnWidth;
                        }
                    });

                    // Find the length of the longest status name
                    let maxLength = 0;
                    tasks.forEach(task => {
                        if (task.status.length > maxLength) {
                            maxLength = task.status.length;
                        }
                    });

                    // Create table for each category
                    sortedCategories.forEach(category => {
                        const table = document.createElement('table');
                        table.innerHTML = `<thead><tr><th colspan="5">${category}</th></tr><tr><th style="width: 15%;">Task Name</th><th style="width: 40%;">Task Description</th><th style="width: 5%;">Status</th><th style="width: 22%;">Actions</th><th class="with-column" style="width: ${maxWithColumnWidth}px;">With</th></tr></thead><tbody id="${category.replace(' ', '_')}"></tbody>`;
                        taskTables.appendChild(table);

                        const tbody = document.getElementById(category.replace(' ', '_'));
                        groupedTasks[category].forEach(task => {
                            const row = document.createElement('tr');
                            const statusWidth = (maxLength * 8) + 20; // Calculate width based on the longest status name
                            row.innerHTML = `<td>${task.name}</td><td>${task.description}</td><td><div class="status-box ${getStatusClass(task.status)}" style="width: ${statusWidth}px"><span class="status-name">${task.status}</span></div></td><td><button class="delete" onclick="deleteTask(${task.id})">Delete</button><button class="in-progress" onclick="changeStatus(${task.id}, 'in-progress')">In Progress</button><button class="done" onclick="changeStatus(${task.id}, 'done')">Done</button><button class="to-do" onclick="changeStatus(${task.id}, 'to-do')">To-Do</button></td><td>${task.with}</td></tr>`;
                            tbody.appendChild(row);
                        });
                    });

                    // Show all tables
                    taskTables.style.display = 'block';
                    document.getElementById('allTasksHeading').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching tasks:', error);
                });
        }

        // Function to delete task
        function deleteTask(taskId) {
            fetch(`/delete_task/${taskId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    showTasks(); // Refresh task list after deletion
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                });
        }

        // Function to change task status
        function changeStatus(taskId, status) {
            fetch(`/change_status/${taskId}/${status}`, {
                method: 'PUT'
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    showTasks(); // Refresh task list after status change
                })
                .catch(error => {
                    console.error('Error changing status:', error);
                });
        }

        // Function to fetch colleagues
        function fetchColleagues() {
            fetch('/get_colleagues')
                .then(response => response.json())
                .then(colleagues => {
                    const select = document.getElementById('colleague_id');
                    select.innerHTML = '<option value="" selected>Select colleague</option>';
                    colleagues.forEach(colleague => {
                        const option = document.createElement('option');
                        option.value = colleague.id;
                        option.text = colleague.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching colleagues:', error);
                });
        }

        // Function to show colleague form
        function showColleagueForm() {
            const colleagueForm = document.getElementById('colleagueForm');
            colleagueForm.style.display = 'block';
        }

        // Function to add new colleague
        function addColleague() {
            const form = document.getElementById('addColleagueForm');
            const formData = new FormData(form);
            const name = formData.get('name');

            fetch('/add_colleague', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('colleagueResponseMsg').textContent = data.message;
                    fetchColleagues(); // Refresh the colleagues dropdown
                    form.reset(); // Clear the form fields
                    setTimeout(() => {
                        document.getElementById('colleagueResponseMsg').textContent = ''; // Clear the response message after 3 seconds
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error adding colleague:', error);
                });
        }

        // Fetch categories and colleagues when the page loads
        window.onload = function () {
            fetch('/get_categories')
                .then(response => response.json())
                .then(categories => {
                    const select = document.getElementById('category_id');
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.text = category.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching categories:', error);
                });

            fetchColleagues();
        };

        // Function to get status class
        function getStatusClass(status) {
            switch (status) {
                case 'to-do':
                    return 'status-to-do';
                case 'in-progress':
                    return 'status-in-progress';
                case 'done':
                    return 'status-done';
                default:
                    return '';
            }
        }
    </script>
</body>
</html>

